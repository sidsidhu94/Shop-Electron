{% extends "base.html" %} 

{% block content %}
<!--Shopping Cart Area Strat-->
<!-- <div class="Shopping-cart-area pt-60 pb-60">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <form action="#">
                    <div class="table-content table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="li-product-remove">remove</th>
                                    <th class="li-product-thumbnail">images</th>
                                    <th class="cart-product-name">Product</th>
                                    <th class="li-product-price">Unit Price</th>
                                    <th class="li-product-quantity">Quantity</th>
                                    <th class="li-product-subtotal">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="li-product-remove"><a href="#"><i class="fa fa-times"></i></a></td>
                                    <td class="li-product-thumbnail"><a href="#"><img src="images/product/small-size/5.jpg" alt="Li's Product Image"></a></td>
                                    <td class="li-product-name"><a href="#">Accusantium dolorem1</a></td>
                                    <td class="li-product-price"><span class="amount">₹46.80</span></td>
                                    <td class="quantity">
                                        <label>Quantity</label>
                                        <div class="cart-plus-minus">
                                            <input class="cart-plus-minus-box" value="1" type="text">
                                            <div class="dec qtybutton"><i class="fa fa-angle-down"></i></div>
                                            <div class="inc qtybutton"><i class="fa fa-angle-up"></i></div>
                                        </div>
                                    </td>
                                    <td class="product-subtotal"><span class="amount">₹70.00</span></td>
                                </tr>
                                <tr>
                                    <td class="li-product-remove"><a href="#"><i class="fa fa-times"></i></a></td>
                                    <td class="li-product-thumbnail"><a href="#"><img src="images/product/small-size/6.jpg" alt="Li's Product Image"></a></td>
                                    <td class="li-product-name"><a href="#">Mug Today is a good day</a></td>
                                    <td class="li-product-price"><span class="amount">₹71.80</span></td>
                                    <td class="quantity">
                                        <label>Quantity</label>
                                        <div class="cart-plus-minus">
                                            <input class="cart-plus-minus-box" value="1" type="text">
                                            <div class="dec qtybutton"><i class="fa fa-angle-down"></i></div>
                                            <div class="inc qtybutton"><i class="fa fa-angle-up"></i></div>
                                        </div>
                                    </td>
                                    <td class="product-subtotal"><span class="amount">₹60.50</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="coupon-all">
                                <div class="coupon">
                                    <input id="coupon_code" class="input-text" name="coupon_code" value="" placeholder="Coupon code" type="text">
                                    <input class="button" name="apply_coupon" value="Apply coupon" type="submit">
                                </div>
                                <div class="coupon2">
                                    <input class="button" name="update_cart" value="Update cart" type="submit">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5 ml-auto">
                            <div class="cart-page-total">
                                <h2>Cart totals</h2>
                                <ul>
                                    <li>Subtotal <span>₹130.00</span></li>
                                    <li>Total <span>₹130.00</span></li>
                                </ul>
                                <a href="#">Proceed to checkout</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div> -->
<!--Shopping Cart Area End-->
<div class="Shopping-cart-area pt-60 pb-60">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <form action="#" method="post">
                    <div class="table-content table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="li-product-remove">Remove</th>
                                    <th class="li-product-thumbnail">Images</th>
                                    <th class="cart-product-name">Product</th>
                                    <th class="li-product-price">Unit Price</th>
                                    <th class="li-product-quantity">Quantity</th>
                                    <th class="li-product-subtotal">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cart_item in cartitems %}
                                <tr>
                                    <td class="li-product-remove">
                                        <a href="{% url 'remove_cart' cart_item.uid %}">
                                            <i class="fa fa-times"></i>
                                        </a>
                                    </td>
                                    <td class="li-product-thumbnail">
                                        <a href="#">
                                            <img style="width: 100px; height: 70px" src="{{ cart_item.variant.product.image.url }}" alt="Li's Product Image">
                                        </a>
                                    </td>
                                    <td class="li-product-name">
                                        <a href="">{{ cart_item.variant.variant_name }}</a>
                                    </td>
                                    <td class="li-product-price">
                                        <span class="amount">{{ cart_item.variant.variant_name }}</span>
                                    </td>
                                    <td class="quantity">
                                        <label>Quantity</label>
                                        <div class="cart-plus-minus">
                                            <input class="cart-plus-minus-box" name="quantity" value="{{ cart_item.variant_quantity }}" type="text" min="1" onchange="updateCartItem(this, '{{ cart_item.variant.price }}', '{{ cart_item.variant.variant_quantity }}', '{{ cart_item.variant.id }}')">
                                            <div class="dec qtybutton" onclick="decrementQuantity(this)"><i class="fa fa-angle-down"></i></div>
                                            <div class="inc qtybutton" onclick="incrementQuantity(this, '{{ cart_item.variant.price }}', '{{ cart_item.variant.id }}')"><i class="fa fa-angle-up"></i></div>
                                        </div>
                                    </td>
                                    <td class="product-subtotal">
                                        <span class="amount" id="productSubtotal{{ cart_item.variant.id }}">₹{{ cart_item.get_product_price }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="coupon-all">
                                <div class="coupon">
                                    <input id="coupon_code" class="input-text" name="coupon_code" value="" placeholder="Coupon code" type="text">
                                    <input class="button" name="apply_coupon" value="Apply coupon" type="submit">
                                </div>
                                <div class="coupon2">
                                    <input class="button" name="update_cart" value="Update cart" type="submit">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5 ml-auto">
                            <div class="cart-page-total">
                                <h2>Cart totals</h2>
                                <ul>
                                    <li>Subtotal <span>₹{{ subtotal }}</span></li>
                                    <li>Total <span>₹{{ total }}</span></li>
                                </ul>
                                <a href="{% url 'checkout' %}">Proceed to checkout</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('click', function(event) {
        var target = event.target;

        if (target.classList.contains('plus-btn') || target.classList.contains('minus-btn')) {
            var cartItem = target.closest('.cart-item');
            var itemId = cartItem.getAttribute('data-item-id');
            var isAdding = target.classList.contains('plus-btn');
            var qtyInput = cartItem.querySelector('.qty-input');
            var quantity = parseInt(qtyInput.value);

            if (isAdding) {
                quantity += 1;
            } else if (quantity > 1) {
                quantity -= 1;
            } else {
                return;
            }

            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'update_cart_quantity');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        if (data.status === 'error') {
                            alert(data.message);
                            document.getElementById('message').textContent = data.message;
                        } else {
                            console.log(data);
                            qtyInput.value = data.quantity;
                            document.getElementById('cart_total').textContent = data.total;
                            document.getElementById('cartitems').textContent = data.cartitems;
                            document.getElementById('sub-total-' + itemId).textContent = data.sub_total;
                            console.log(data.sub_total);
                            document.getElementById('grand_total').textContent = data.grand_total;
                        }
                    } else {
                        document.getElementById('errorMessage').textContent = 'An error occurred while updating the cart.';
                        document.getElementById('errorModal').modal('show');
                    }
                }
            };

            var csrfToken = '{{ csrf_token }}';
            var formData = 'item_id=' + itemId + '&quantity=' + quantity + '&csrfmiddlewaretoken=' + csrfToken;
            xhr.send(formData);
        }
    });
</script>

    

{% endblock %}